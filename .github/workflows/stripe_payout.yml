name: Stripe Connect — Pagamentos Automáticos

on:
  schedule:
    # Corre todos os dias à meia-noite (UTC)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (não chama Stripe, só mostra o que faria)'
        type: boolean
        default: false

jobs:
  payout:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Processar levantamentos pendentes
        env:
          SUPABASE_URL:       ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY:       ${{ secrets.SUPABASE_KEY }}
          STRIPE_SECRET_KEY:  ${{ secrets.STRIPE_SECRET_KEY }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            python scripts/stripe_payout.py --dry-run
          else
            python scripts/stripe_payout.py
          fi

      - name: Resumo
        if: always()
        run: echo "Workflow Stripe concluído — verificar logs acima"
