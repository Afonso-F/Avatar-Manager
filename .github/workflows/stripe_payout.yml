name: Stripe — Payout Automático Diário

on:
  schedule:
    # Corre todos os dias às 02:00 UTC (após a liquidação de saldos Stripe)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (não chama Stripe, só mostra o que faria)'
        type: boolean
        default: false

jobs:
  payout:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Executar payout automático diário
        env:
          SUPABASE_URL:                ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY:                ${{ secrets.SUPABASE_KEY }}
          STRIPE_SECRET_KEY:           ${{ secrets.STRIPE_SECRET_KEY }}
          # ID ba_xxx da conta bancária registada na conta Stripe principal.
          # Necessário para o payout directo da plataforma para a tua conta.
          STRIPE_MAIN_BANK_ACCOUNT_ID: ${{ secrets.STRIPE_MAIN_BANK_ACCOUNT_ID }}
          # Montante mínimo em cêntimos para activar payout automático (default 1000 = €10).
          STRIPE_MIN_PAYOUT_CENTS:     ${{ secrets.STRIPE_MIN_PAYOUT_CENTS || '1000' }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            python scripts/stripe_payout.py --dry-run
          else
            python scripts/stripe_payout.py
          fi

      - name: Resumo
        if: always()
        run: |
          echo "Workflow Stripe concluído — verificar logs acima"
          echo "Fases executadas:"
          echo "  1. Auto-collect: levantamentos criados para contas com payout automático activo"
          echo "  2. Pendentes: todos os levantamentos pendentes processados via Stripe Connect"
          echo "  3. Principal: payout da conta Stripe principal para conta bancária do titular"
